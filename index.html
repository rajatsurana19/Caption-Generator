<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caption Generator</title>
</head>
<body>
    <div class="container">
        <h1>Caption Generator<h1>
        <p class="subtitle">Upload a video to generate subtitles (.srt)</p>

        <div class="upload-area" id="uploadArea">
            <p><strong>Click to upload</strong> or drag & drop</p>
            <p>MP4, MOV, AVI supported</p>
        </div>

        <input type="file" id="fileInput" accept="video/*">

        <div class="file-name" id="fileName"></div>

        <div class="video-preview" id="videoPreview">
            <video id="videoPlayer" controls></video>
        </div>

        <button class="btn" id="generateBtn">Generate Captions</button>

        <div class="status" id="status"></div>

        <div class="srt-output" id="srtOutput">
        <pre id="srtContent"></pre>
        </div>

        <button class="btn download-btn" id="downloadBtn">Download .SRT</button>
    </div>

<script>
    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");
    const videoPreview = document.getElementById("videoPreview");
    const videoPlayer = document.getElementById("videoPlayer");
    const generateBtn = document.getElementById("generateBtn");
    const statusBox = document.getElementById("status");
    const srtOutput = document.getElementById("srtOutput");
    const srtContent = document.getElementById("srtContent");
    const downloadBtn = document.getElementById("downloadBtn");
    const fileName = document.getElementById("fileName");

    let currentVideoFile = null;
    let generatedSrt = "";

    uploadArea.onclick = () => fileInput.click();

    fileInput.onchange = e => {
        if (e.target.files.length > 0) handleFile(e.target.files[0]);
    };

    function handleFile(file) {
        if (!file.type.includes("video")) {
            alert("Please upload a valid video file");
            return;
        }

        currentVideoFile = file;
        videoPlayer.src = URL.createObjectURL(file);

        videoPreview.classList.add("active");
        generateBtn.classList.add("active");
        fileName.classList.add("active");
        fileName.textContent = "Selected: " + file.name;

        hideOutput();
    }

    generateBtn.onclick = () => {
        if (!currentVideoFile) return;

        generateBtn.disabled = true;
        showStatus("processing", "Uploading & processing video...");

        const formData = new FormData();
        formData.append("video", currentVideoFile);

        fetch("http://localhost:5000/upload", {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.srt) {
                generatedSrt = data.srt;
                srtContent.textContent = generatedSrt;
                srtOutput.classList.add("active");
                downloadBtn.classList.add("active");
                showStatus("success", "Captions generated successfully!");
            } else {
                showStatus("error", data.error || "Something went wrong");
            }
        })
        .catch(err => {
            showStatus("error", "Backend not running or CORS issue");
            console.error(err);
        })
        .finally(() => {
            generateBtn.disabled = false;
        });
    };

    downloadBtn.onclick = () => {
        const blob = new Blob([generatedSrt], { type: "text/plain" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "captions.srt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        URL.revokeObjectURL(url);
    };

    function showStatus(type, message) {
        statusBox.className = `status active ${type}`;
        statusBox.textContent = message;
    }

    function hideOutput() {
        srtOutput.classList.remove("active");
        downloadBtn.classList.remove("active");
        statusBox.classList.remove("active");
    }
</script>

</body>
</html>
